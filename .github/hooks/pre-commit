#!/bin/bash

# Pre-commit hook pour StopDiab√®te
# Place ce fichier dans .git/hooks/pre-commit et rends-le ex√©cutable

echo "üîç Running pre-commit checks..."

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check for console.log in staged files
echo ""
echo "üìù Checking for console.log statements..."
if git diff --cached --name-only | grep -E '\.(ts|tsx|js|jsx)$' | xargs grep -n "console\.log" 2>/dev/null; then
    echo -e "${YELLOW}‚ö†Ô∏è  Warning: console.log statements found${NC}"
    echo "Consider removing them or using proper logging"
    read -p "Continue anyway? (y/n) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

# Check for TODO/FIXME comments
echo ""
echo "üìã Checking for TODO/FIXME comments..."
if git diff --cached --name-only | xargs grep -n "TODO\|FIXME" 2>/dev/null; then
    echo -e "${YELLOW}‚ö†Ô∏è  Warning: TODO/FIXME comments found${NC}"
fi

# Check for large files
echo ""
echo "üìè Checking for large files (>500KB)..."
LARGE_FILES=$(git diff --cached --name-only | xargs ls -lh 2>/dev/null | awk '$5 ~ /[0-9]+M/ || ($5 ~ /[0-9]+K/ && $5+0 > 500)')
if [ ! -z "$LARGE_FILES" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Warning: Large files detected:${NC}"
    echo "$LARGE_FILES"
    read -p "Continue anyway? (y/n) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

# Check for sensitive data patterns
echo ""
echo "üîí Checking for potential sensitive data..."
SENSITIVE_PATTERNS="password|secret|api_key|private_key|token"
if git diff --cached | grep -iE "$SENSITIVE_PATTERNS" | grep -v "example" | grep -v "test" 2>/dev/null; then
    echo -e "${RED}‚ùå Error: Potential sensitive data found!${NC}"
    echo "Please remove sensitive data before committing"
    exit 1
fi

# Run TypeScript check (if tsconfig exists)
if [ -f "backend/tsconfig.json" ]; then
    echo ""
    echo "üîß Checking TypeScript (backend)..."
    cd backend
    if ! npm run build --silent > /dev/null 2>&1; then
        echo -e "${RED}‚ùå TypeScript compilation failed in backend${NC}"
        echo "Run 'cd backend && npm run build' to see errors"
        exit 1
    fi
    cd ..
fi

if [ -f "frontend/tsconfig.json" ]; then
    echo ""
    echo "üîß Checking TypeScript (frontend)..."
    cd frontend
    if ! npm run build --silent > /dev/null 2>&1; then
        echo -e "${RED}‚ùå TypeScript compilation failed in frontend${NC}"
        echo "Run 'cd frontend && npm run build' to see errors"
        exit 1
    fi
    cd ..
fi

echo ""
echo -e "${GREEN}‚úÖ All pre-commit checks passed!${NC}"
exit 0
